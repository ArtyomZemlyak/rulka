# Window Focus Fix

## Проблема

При параллельной тренировке с несколькими инстансами TrackMania машины переставали ехать через некоторое время после начала тренировки. Они просто "дрыгались" на старте, не двигаясь вперед.

### Симптомы:
- Машины останавливаются и не реагируют на управление
- При клике на конкретное окно инстанса машина начинает работать нормально
- Проблема возникает случайным образом у разных инстансов
- После потери фокуса игра продолжает рендериться, но не обрабатывает инпуты

## Причина

**TMInterface не обрабатывает инпуты из окон без фокуса**, даже если установлена настройка `unfocused_fps_limit false`.

Настройка `unfocused_fps_limit false` позволяет игре продолжать симуляцию с полной скоростью без фокуса, но **не позволяет обрабатывать инпуты** (клавиши управления).

### Усугубление проблемы при смене карт

Проблема особенно заметна при тренировке на **нескольких картах** в цикле:
- При загрузке новой карты окно временно теряет фокус
- После загрузки карты фокус не восстанавливается автоматически
- Следующие инпуты не обрабатываются до ручного клика на окно
- Это приводит к "зависанию" машины на старте новой карты

**Важно:** С одной картой проблема может проявляться реже, так как смены карт не происходит.

## Решение (ИСПРАВЛЕННОЕ)

### Ключевое понимание

После глубокого анализа выяснилось:
- TMInterface отправляет инпуты через **socket API**, а не симуляцию клавиш
- Игра TmForever требует фокус **только один раз после загрузки карты** для инициализации
- **Постоянное переключение фокуса** создает "войну за фокус" между 8 параллельными инстансами
- Это вызывает мерцание окон и потерю производительности

### 1. Добавлены вспомогательные функции

```python
def is_window_focused(trackmania_window):
    """Проверяет, находится ли окно TrackMania в фокусе."""
    # Использует win32gui.GetForegroundWindow() на Windows
    # Использует xdo.get_active_window() на Linux

def ensure_window_focused(trackmania_window):
    """Гарантирует, что окно не минимизировано и находится в фокусе."""
    # Сначала проверяет минимизацию
    # Затем проверяет фокус
    # Устанавливает фокус только если окно не в фокусе
```

### 2. Логика установки фокуса

**Было:** Фокус устанавливался только один раз при первом действии (игнорируя смену карт)

**Неправильное решение:** Фокус при каждом действии → "война за фокус" между инстансами

**Правильное решение:** Фокус устанавливается **один раз после каждой загрузки карты**

```python
# Фокус устанавливается только один раз после активации/загрузки карты
if not self.game_activated:
    ensure_window_focused(self.tm_window_id)
    self.game_activated = True

self.request_inputs(action_idx, rollout_results)
```

**Почему это работает:**
- TMInterface использует socket API для отправки команд
- Игре нужен фокус только для **инициализации** после загрузки карты
- После инициализации команды обрабатываются через API независимо от фокуса

### 3. Сброс флага активации при смене карты

При загрузке новой карты флаг `game_activated` сбрасывается в `False`:

```python
def request_map(self, map_path: str, zone_centers: npt.NDArray):
    # ... код загрузки карты ...
    
    # CRITICAL: Reset game_activated flag when loading new map
    # This ensures window will be focused on first input after map change
    self.game_activated = False
```

Это гарантирует, что после загрузки каждой новой карты окно получит фокус при первом действии.

### 4. Настройка (устаревшая)

В `config_files/performance_config.py`:

```python
# NOTE: Настройка оставлена для совместимости, но больше не используется
# Фокус управляется автоматически через сброс game_activated при загрузке карты
force_window_focus_on_input = False  # Deprecated
```

**Важно:** Постоянное переключение фокуса (`True`) создаст "войну за фокус" между инстансами!

## Влияние на производительность

### Накладные расходы (минимальные)
- Проверка фокуса: ~0.1ms на Windows (вызов `GetForegroundWindow()`)
- Установка фокуса: ~1-5ms на Windows (только если окно не в фокусе)
- **Частота:** только **1 раз на карту** (не на каждое действие!)
- Общее влияние: < 0.01% от времени тренировки

### Почему нет "войны за фокус"
- Каждый инстанс устанавливает фокус только при загрузке новой карты
- Между инстансами есть естественная рассинхронизация
- `game_spawning_lock` предотвращает одновременный запуск инстансов
- После установки фокуса инстанс работает независимо через socket API

## Использование

### Рекомендуемая настройка (автоматически)
```python
force_window_focus_on_input = False  # Фокус управляется автоматически
```

Фокус устанавливается **автоматически** при каждой загрузке карты через сброс `game_activated = False`. Это оптимальное решение, не требующее ручной настройки.

### ⚠️ НЕ рекомендуется
```python
force_window_focus_on_input = True  # Создаст "войну за фокус"!
```

Это вызовет постоянное переключение между 8 инстансами, мерцание окон и потерю производительности.

## Тестирование

1. Запустите тренировку с несколькими инстансами:
   ```bash
   python scripts/train.py
   ```

2. Проверьте, что все машины едут:
   - Машины должны двигаться на всех окнах одновременно
   - Можно переключаться между окнами - все должны продолжать работать

3. **Особенно важно:** Проверьте смену карт:
   - При тренировке на нескольких картах (`map_cycle` с 2+ картами)
   - Убедитесь, что машины продолжают ехать после загрузки новой карты
   - Первая машина на новой карте должна начать движение сразу
   - Не должно быть "зависания" на старте новой карты

4. Проверьте логи:
   - Не должно быть сообщений о timeout
   - Все инстансы должны генерировать опыт с одинаковой скоростью
   - Сообщения `[OK] Start state saved for ...` должны появляться для каждой новой карты

## Дополнительные улучшения

### Добавлена обработка ошибок
- Все функции управления окнами обернуты в try-except
- Проверка на `None` перед операциями с окнами
- Graceful degradation при ошибках

### Кроссплатформенность
- Windows: использует `win32gui`
- Linux: использует `xdo` (python-libxdo)

## Альтернативные решения (не реализованы)

1. **Использование виртуального дисплея (Xvfb на Linux)**
   - Каждый инстанс на своем виртуальном дисплее
   - Не требует фокуса для работы
   - Сложнее в настройке

2. **Модификация TMInterface**
   - Изменить TMInterface для обработки инпутов без фокуса
   - Требует изменения исходного кода TMInterface
   - Не совместимо с официальными версиями

3. **Использование DirectInput вместо SendKeys**
   - Более низкоуровневая отправка инпутов
   - Может работать без фокуса
   - Требует значительных изменений в TMInterface

## Ссылки

- [TMInterface документация](https://donadigo.com/tminterface/)
- [win32gui.GetForegroundWindow](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getforegroundwindow)
- [python-libxdo](https://github.com/rshk/python-libxdo)

---

## История изменений

### 2026-01-25: Финальное решение (РАБОТАЕТ ✅)

**Подтверждено работающим в production!**

Ключевые моменты решения:
1. Фокус устанавливается **только при смене карты** через сброс `game_activated = False` в `request_map()`
2. При повторных заездах на той же карте фокус НЕ меняется (оптимально)
3. Избегает "войны за фокус" между 8 параллельными инстансами
4. Минимальные накладные расходы (<0.01%)

**Тестирование:** Проверено на 8 параллельных инстансах с несколькими картами в цикле.

---

**Статус:** ✅ Исправлено и протестировано в production  
**Дата:** 2026-01-25  
**Автор:** ArtyomZemlyak
